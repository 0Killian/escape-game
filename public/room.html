<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Escape Game - Salle</title>
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #fff; }
    .container { max-width: 500px; margin: 60px auto; background: #333; padding: 30px; border-radius: 8px; }
    .players { margin-top: 20px; }
    .host { color: #ffd700; }
    .code { font-size: 1.2em; margin-bottom: 10px; }
    .status { margin-top: 10px; }
    button { margin-top: 20px; padding: 10px; border-radius: 4px; border: none; background: #ff4444; color: #fff; cursor: pointer; }
    button:hover { background: #b30000; }
    .error { color: #ff4444; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="code" id="roomCode"></div>
    <div id="host"></div>
    <div class="players" id="players"></div>
    <div class="status" id="status"></div>
    <button id="leaveBtn">Quitter</button>
    <div class="error" id="errorMsg"></div>
  </div>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script>
    const socket = io();
    const roomCode = new URLSearchParams(window.location.search).get('code') || localStorage.getItem('roomCode');
    const pseudo = localStorage.getItem('pseudo');
    const playerId = localStorage.getItem('playerId');
    document.getElementById('roomCode').textContent = `Code salle : ${roomCode}`;
    let isHost = false;
    function showError(msg) {
      document.getElementById('errorMsg').textContent = msg;
    }
    function updatePlayers(players) {
      const list = players.map(p => `<li${p.isHost ? ' class="host"' : ''}>${p.pseudo}${p.isHost ? ' (Host)' : ''}${!p.connected ? ' [déconnecté]' : ''}</li>`).join('');
      document.getElementById('players').innerHTML = `<ul>${list}</ul>`;
      isHost = players.find(p => p.id === playerId)?.isHost;
      document.getElementById('host').textContent = isHost ? 'Vous êtes l’hôte.' : '';
      document.getElementById('status').textContent = players.length < 2 ? 'En attente de joueur...' : 'Salle complète.';
    }
    if (playerId) {
      socket.emit('room:reconnect', { playerId, roomCode });
    } else {
      socket.emit('room:join', { code: roomCode, pseudo });
    }
    socket.on('room:joined', ({ room, players, self }) => {
      localStorage.setItem('playerId', self.id);
      updatePlayers(players);
    });
    socket.on('room:update', ({ players }) => {
      updatePlayers(players);
    });
    socket.on('room:host-changed', ({ playerId: newHostId }) => {
      if (newHostId === playerId) document.getElementById('host').textContent = 'Vous êtes l’hôte.';
    });
    socket.on('room:full', () => {
      showError('Salle pleine');
    });
    socket.on('room:not-found', () => {
      showError('Salle inexistante');
    });
    socket.on('room:reconnected', () => {
      // rien à faire, la liste sera broadcast
    });
    document.getElementById('leaveBtn').onclick = () => {
      socket.emit('room:leave');
      localStorage.removeItem('playerId');
      window.location = '/form.html';
    };
  </script>
</body>
</html>
