<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <title>Escape Game - Salle</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #222;
                color: #fff;
            }
            .container {
                max-width: 500px;
                margin: 60px auto;
                background: #333;
                padding: 30px;
                border-radius: 8px;
            }
            .players {
                margin-top: 20px;
            }
            .host {
                color: #ffd700;
            }
            .code {
                font-size: 1.2em;
                margin-bottom: 10px;
            }
            .status {
                margin-top: 10px;
            }
            button {
                margin-top: 20px;
                padding: 10px;
                border-radius: 4px;
                border: none;
                background: #ff4444;
                color: #fff;
                cursor: pointer;
            }
            button:hover {
                background: #b30000;
            }
            .error {
                color: #ff4444;
                margin-top: 10px;
            }
        </style>
        <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    </head>
    <body>
        <div class="container">
            <div class="code" id="roomCode"></div>
            <div id="host"></div>
            <div class="players" id="players"></div>
            <div class="status" id="status"></div>
            <button id="leaveBtn">Quitter</button>
            <div class="error" id="errorMsg"></div>
        </div>
        <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
        <script src="/assets/main.js"></script>
        <script>
            function showError(msg) {
                document.getElementById("errorMsg").textContent = msg;
            }

            const roomCode = localStorage.getItem("roomCode");
            const pseudo = localStorage.getItem("pseudo");

            const listeners = {
                onJoined: (server, player) => {
                    const list = server.state.room.players
                        .map(
                            (p) =>
                                `<li${p.isHost ? ' class="host"' : ""}>${p.pseudo}${p.isHost ? " (Hôte)" : ""}${!p.connected ? " [déconnecté]" : ""}</li>`,
                        )
                        .join("");
                    document.getElementById("players").innerHTML =
                        `<ul>${list}</ul>`;

                    document.getElementById("status").textContent =
                        server.state.room.players.length < 2
                            ? "En attente de joueur..."
                            : "Salle complète.";
                },
                onPlayerLeft: (server, player) => {
                    const list = server.state.room.players
                        .map(
                            (p) =>
                                `<li${p.isHost ? ' class="host"' : ""}>${p.pseudo}${p.isHost ? " (Hôte)" : ""}${!p.connected ? " [déconnecté]" : ""}</li>`,
                        )
                        .join("");
                    document.getElementById("players").innerHTML =
                        `<ul>${list}</ul>`;

                    document.getElementById("status").textContent =
                        server.state.room.players.length < 2
                            ? "En attente de joueur..."
                            : "Salle complète.";
                },
                onHostChanged: (server, player) => {
                    const list = server.state.room.players
                        .map(
                            (p) =>
                                `<li${p.isHost ? ' class="host"' : ""}>${p.pseudo}${p.isHost ? " (Hôte)" : ""}${!p.connected ? " [déconnecté]" : ""}</li>`,
                        )
                        .join("");
                    document.getElementById("players").innerHTML =
                        `<ul>${list}</ul>`;

                    isHost = server.state.self.isHost;
                    document.getElementById("host").textContent = isHost
                        ? "Vous êtes l’hôte."
                        : "";
                },
                onError: (server, error) => {
                    switch (error) {
                        case "room:full":
                            showError("Salle pleine");
                            break;
                        case "room:not-found":
                            showError("Salle inexistante");
                            break;
                        default:
                            showError("Erreur inconnue");
                            console.error(error);
                            break;
                    }
                },
                onConnected: (server) => {
                    console.log(server.state);
                    const list = server.state.room.players
                        .map(
                            (p) =>
                                `<li${p.isHost ? ' class="host"' : ""}>${p.pseudo}${p.isHost ? " (Hôte)" : ""}${!p.connected ? " [déconnecté]" : ""}</li>`,
                        )
                        .join("");
                    document.getElementById("players").innerHTML =
                        `<ul>${list}</ul>`;

                    document.getElementById("status").textContent =
                        server.state.room.players.length < 2
                            ? "En attente de joueur..."
                            : "Salle complète.";

                    document.getElementById("roomCode").textContent =
                        `Code salle : ${roomCode}`;

                    document.getElementById("leaveBtn").onclick = () => {
                        server.leave();
                        localStorage.removeItem("playerId");
                        window.location = "/form.html";
                    };
                },
            };

            (async () => {
                await joinRoom(pseudo, roomCode, listeners);
            })();
        </script>
    </body>
</html>
